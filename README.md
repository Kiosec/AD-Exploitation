# AD-exploitation

## Table of contents

##### ➤ Enumerating Active Directory

* [1. Manual enumeration](#Manual-enumeration)
* [2. Automated tools](#Automated-enumeration)


## Active Directory enumeration through Microsoft Management Console (MMC)

##### ➤ Requirements
- RDP or GUI access
- RSAT feature activated or can be activated

##### ➤ Limits
- The GUI requires RDP access to the machine where it is executed.
- Although searching for an object is fast, gathering AD wide properties or attributes cannot be performed. 

##### ➤ Detect if MMC is installed/activated

```
1. Right click on Windows
2. Click on 'run'
3. Write 'MMC' and execute 
```

##### ➤ Install MMC

If the Microsoft Management Console is not directly installed, you can perform the following steps to install RSAT (Remote Server Administration Tools) which include MMC.

```
1. Press Right on Windows
2. Search 'Apps and Features'
3. Click 'Manage Optional Features'
4. Click 'Add a feature'
5. Search for 'RSAT'
6. Select 'RSAT: Active Directory Domain Services and Lightweight Directory Tools' and click Install
```

You can now execute MMC, then we can now attach the AD RSAT Snap-In:
```
1. Click File -> Add/Remove Snap-in
2. Select and Add all three Active Directory Snap-ins
3. Click through any errors and warnings
4. Right-click on Active Directory Domains and Trusts and select Change Forest
Enter <YOUR_DOMAIN> as the Root domain and Click OK
5. Right-click on Active Directory Sites and Services and select Change Forest
Enter <YOUR_DOMAIN> as the Root domain and Click OK
6. Right-click on Active Directory Users and Computers and select Change Domain
Enter <YOUR_DOMAIN> as the Domain and Click OK
7. Right-click on Active Directory Users and Computers in the left-hand pane
8. Click on View -> Advanced Features
```

![image](https://github.com/Kiosec/AD-exploitation/assets/100965892/b503e429-8772-4e51-a001-a1ca97e4311e)


##### ➤ Execute MMC with specific user

```
1. Right click on Windows
2. Click on 'run'
3. Write 'MMC' and execute 
```

**Run MMC with a specific user (RUNAS):** This is where the Runas window  comes into play. In that window, we can start MMC, which will ensure that all MMC network connections will use our injected AD credentials.


## Active Directory enumeration through Command Prompt

## Active Directory enumeration through Powershell

## Active Directory enumeration through Bloodhound

## Active Directory enumeration through ADExplorer

## Active Directory enumeration through ADRecon

## Enumerating Active Directory
/netonly - Since we are not domain-joined, we want to load the credentials for network authentication but not authenticate against a domain controller. So commands executed locally on the computer will run in the context of your standard Windows account, but any network connections will occur using the account specified here.
/user - Here, we provide the details of the domain and the username. It is always a safe bet to use the Fully Qualified Domain Name (FQDN) instead of just the NetBIOS name of the domain since this will help with resolution.
cmd.exe - This is the program we want to execute once the credentials are injected. This can be changed to anything, but the safest bet is cmd.exe since you can then use that to launch whatever you want, with the credentials injected.

```
runas.exe /netonly /user:<domain>\<username> cmd.exe
```


## Test is credential is valid 
```
C:\Tools>dir \\my.domain.com\SYSVOL\
 Volume in drive \\my.domain.com\SYSVOL is Windows
 Volume Serial Number is 1634-22A9

 Directory of \\my.domain.com\SYSVOL

02/24/2022  09:57 PM    <DIR>          .
02/24/2022  09:57 PM    <DIR>          ..
02/24/2022  09:57 PM    <JUNCTION>     my.domain.com [C:\Windows\SYSVOL\domain]
               0 File(s)              0 bytes
               3 Dir(s)  51,835,408,384 bytes free
```


Is there a difference between dir \\my.domain.com\SYSVOL and dir \\<DC IP>\SYSVOL and why the big fuss about DNS?

There is quite a difference, and it boils down to the authentication method being used. When we provide the hostname, network authentication will attempt first to perform Kerberos authentication. Since Kerberos authentication uses hostnames embedded in the tickets, if we provide the IP instead, we can force the authentication type to be NTLM. While on the surface, this does not matter to us right now, it is good to understand these slight differences since they can allow you to remain more stealthy during a Red team assessment. In some instances, organisations will be monitoring for OverPass- and Pass-The-Hash Attacks. Forcing NTLM authentication is a good trick to have in the book to avoid detection in these cases.
